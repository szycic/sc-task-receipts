<!DOCTYPE html>
<html>
<head>
    <title>Tasks Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{{ request.url_for('static', path='favicon.ico') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='style.css') }}">
</head>
<body>
<div class="container">
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <h1 style="margin:0">Tasks to Print</h1>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="sub">Auto-synced from Notion</div>
      <button id="print-all" class="btn">Print All</button>
    </div>
  </div>

  {% if tasks %}
  <div id="tasks-grid" class="tasks-grid">
    {% for t in tasks %}
      <div class="task-card" data-id="{{ t.id }}">
        <div class="task-row">
          <div class="task-title">{{ t.title }}</div>
          {% if t.priority %}
            <div class="priority {{ t.priority|lower }}">{{ t.priority }}</div>
          {% endif %}
        </div>
        <div class="task-meta small">{{ t.planned_start }} · {{ t.project }}</div>
        <div class="task-actions">
          <button type="button" class="btn btn-sm" onclick="printTask('{{ t.id }}')">Print</button>
          <a class="btn" href="/tasks/{{ t.id }}">Details</a>
        </div>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <div id="no-tasks" class="center muted">No tasks to print</div>
  {% endif %}
</div>

<!-- Toast container -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
function showToast(type, message, duration = 3000){
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type} show`;
  // ensure message is a string
  let msg = message;
  if (typeof msg === 'object'){
    msg = msg && (msg.detail || msg.message) ? (msg.detail || msg.message) : JSON.stringify(msg);
  }
  t.textContent = msg;
  container.appendChild(t);
  // longer for errors
  const hideAfter = type === 'error' ? Math.max(duration, 5000) : duration;
  setTimeout(()=>{ t.classList.remove('show'); t.classList.add('hide'); }, hideAfter);
  setTimeout(()=>{ container.removeChild(t); }, hideAfter + 300);
}

// helper to print a single task from server-rendered buttons
function printTask(id){
  // call the shared client function without a button element
  printTaskClient(id, null);
}

// shared client-side print logic used by dynamic buttons
async function printTaskClient(id, btn){
  try{
    const res = await fetch(`/api/v1/tasks/${id}/print`, { method: 'POST' });
    let body = {};
    try{ body = await res.json(); }catch(e){ /* not json */ }
    if(!res.ok){
      const msg = body.detail || body.message || `Printing failed (status ${res.status})`;
      showToast('error', msg);
      console.error('Print failed for', id, body);
      return;
    }
    // success
    const msg = body.message || 'Printed';
    showToast('success', msg);
    // If server reports failures (batch endpoint forwarded here), show details
    if(body.failures && body.failures.length){
      showToast('error', `${body.failures.length} failed`);
      console.error('Print failures', body.failures);
    }
    setTimeout(()=>refreshTasks(), 600);
  }catch(e){
    console.error('Print request error', e);
    showToast('error', 'Request failed: ' + (e && e.message ? e.message : String(e)));
  }
}

function renderTasks(tasks){
  const grid = document.getElementById('tasks-grid');
  if(!grid){
    // if no grid present, create and insert
    const container = document.querySelector('.container');
    const newGrid = document.createElement('div');
    newGrid.id = 'tasks-grid';
    newGrid.className = 'tasks-grid';
    container.appendChild(newGrid);
  }
  const g = document.getElementById('tasks-grid');
  g.innerHTML = '';
  const noTasksElem = document.getElementById('no-tasks');
  if(noTasksElem) noTasksElem.remove();
  if(!tasks || tasks.length === 0){
    const nt = document.createElement('div');
    nt.id = 'no-tasks'; nt.className='center muted'; nt.textContent='No tasks to print';
    g.parentNode.appendChild(nt);
    return;
  }
  tasks.forEach(t=>{
    const card = document.createElement('div');
    card.className='task-card';
    card.setAttribute('data-id', t.id);

    const row = document.createElement('div'); row.className='task-row';
    const title = document.createElement('div'); title.className='task-title'; title.textContent = t.title;
    row.appendChild(title);
    if(t.priority){
      const pri = document.createElement('div'); pri.className = 'priority ' + (t.priority || '').toLowerCase(); pri.textContent = t.priority;
      row.appendChild(pri);
    }
    card.appendChild(row);

    const meta = document.createElement('div'); meta.className='task-meta small'; meta.textContent = (t.planned_start || '') + ' · ' + (t.project || '');
    card.appendChild(meta);

    const actions = document.createElement('div'); actions.className='task-actions';
    const printBtn = document.createElement('button'); printBtn.className='btn btn-sm'; printBtn.type='button'; printBtn.textContent = 'Print';
    printBtn.addEventListener('click', async (e)=>{ e.preventDefault(); printTaskClient(t.id, printBtn); });
    actions.appendChild(printBtn);
    const a = document.createElement('a'); a.className='btn'; a.href = '/tasks/' + t.id; a.textContent='Details';
    actions.appendChild(a);
    card.appendChild(actions);

    g.appendChild(card);
  });
}

async function refreshTasks(){
  try{
    const res = await fetch('/api/v1/tasks');
    const body = await res.json();
    renderTasks(body.data || []);
  }catch(e){ console.error(e); }
}

// Polling auto-refresh (skip when tab is hidden), similar to task_details
const POLL_INTERVAL = 8000; // ms
let _pollTimer = null;
function startPolling(){
  if(_pollTimer) clearInterval(_pollTimer);
  _pollTimer = setInterval(()=>{
    if(!document.hidden){
      refreshTasks();
    }
  }, POLL_INTERVAL);
}

// refresh immediately when tab becomes visible
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshTasks(); });

// start on load
document.addEventListener('DOMContentLoaded', ()=>{ refreshTasks(); startPolling(); });

document.getElementById("print-all").addEventListener("click", async () => {
    try{
      const response = await fetch("/api/v1/tasks/print", { method: "POST" });
      let result = {};
      try{ result = await response.json(); }catch(e){ /* not json */ }
      if(!response.ok){
        const msg = result.detail || result.message || `Print request failed (status ${response.status})`;
        showToast('error', msg);
        console.error('Print-all failed', result);
        return;
      }

      if(result.failures && result.failures.length){
        showToast('error', `${result.successes || 0} printed, ${result.failures.length} failed`);
        console.error('Print failures', result.failures);
      }else{
        showToast('success', result.message || 'Printed');
      }
      // fetch fresh tasks and re-render
      setTimeout(()=>refreshTasks(), 600);
    }catch(e){
      console.error('Print-all request error', e);
      showToast('error', 'Request failed: ' + (e && e.message ? e.message : String(e)));
    }
});
</script>
</body>
</html>
