<!DOCTYPE html>
<html>
<head>
    <title>Tasks Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{{ request.url_for('static', path='favicon.ico') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='style.css') }}">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-top">
      <h1 style="margin:0">Tasks to Print</h1>
      <div class="sub">Auto-synced from Notion</div>
    </div>
    <div class="header-actions">
      <button id="refresh-projects" class="btn btn-neutral">Refresh Projects</button>
      <button id="print-summary" class="btn">Print Summary</button>
      <button id="print-all" class="btn">Print All</button>
    </div>
  </div>

  {% if tasks %}
  <div id="tasks-grid" class="tasks-grid">
    {% for t in tasks %}
      <div class="task-card" data-id="{{ t.id }}">
        <div class="task-row">
          <div class="task-title">{{ t.title }}</div>
          {% if t.priority %}
            <div class="priority {{ t.priority|lower }}">{{ t.priority }}</div>
          {% endif %}
        </div>
        <div class="task-meta small">{{ t.due_date or "—" }} · {{ t.project or "—" }}</div>
        <div class="task-actions">
          <button type="button" class="btn btn-sm" onclick="printTask('{{ t.id }}')">Print</button>
          <a class="btn" href="/tasks/{{ t.id }}">Details</a>
        </div>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <div id="no-tasks" class="center muted">No tasks to print</div>
  {% endif %}
</div>

<!-- Toast container -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Busy overlay (hidden by default) -->
<div id="busy-overlay" class="busy-overlay hidden" aria-hidden="true">
  <div class="busy-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="busy-text">Printing…</div>
  </div>
</div>

<script>
function showToast(type, message, duration = 3000){
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type} show`;
  // ensure message is a string
  let msg = message;
  if (typeof msg === 'object'){
    msg = msg && (msg.detail || msg.message) ? (msg.detail || msg.message) : JSON.stringify(msg);
  }
  t.textContent = msg;
  container.appendChild(t);
  // longer for errors
  const hideAfter = type === 'error' ? Math.max(duration, 5000) : duration;
  setTimeout(()=>{ t.classList.remove('show'); t.classList.add('hide'); }, hideAfter);
  setTimeout(()=>{ container.removeChild(t); }, hideAfter + 300);
}

// helper to print a single task from server-rendered buttons
function printTask(id){
  // read title from the DOM and forward to shared client function
  const card = document.querySelector(`.task-card[data-id="${id}"]`);
  const titleElem = card ? card.querySelector('.task-title') : null;
  const title = titleElem ? titleElem.textContent.trim() : undefined;
  // call the shared client function without a button element
  printTaskClient(id, null, title);
}

// shared client-side print logic used by dynamic buttons
async function printTaskClient(id, btn, title){
  let printed = false;
  try{
    if (btn) btn.disabled = true;
    const busyMsg = title ? `Printing task "${title}"...` : 'Printing task...';
    showBusy(busyMsg);

    const res = await fetch(`/api/v1/tasks/${id}/print`, { method: 'POST' });
    let body = {};
    try{ body = await res.json(); }catch(e){ /* not json */ }

    if(!res.ok){
      const msg = body.detail || body.message || `Printing failed (status ${res.status})`;
      showToast('error', msg);
      console.error('Print failed for', id, body);
    } else {
      // success
      const msg = body.message || 'Printed';
      showToast('success', msg);
      if(body.failures && body.failures.length){
        showToast('error', `${body.failures.length} failed`);
        console.error('Print failures', body.failures);
      }
      printed = true;
      // refresh tasks so printed state updates
      await refreshTasks();
    }
  }catch(e){
    console.error('Print request error', e);
    showToast('error', 'Request failed: ' + (e && e.message ? e.message : String(e)));
  }finally{
    if (btn) btn.disabled = false;
    hideBusy();
  }
}

function renderTasks(tasks){
  const grid = document.getElementById('tasks-grid');
  if(!grid){
    // if no grid present, create and insert
    const container = document.querySelector('.container');
    const newGrid = document.createElement('div');
    newGrid.id = 'tasks-grid';
    newGrid.className = 'tasks-grid';
    container.appendChild(newGrid);
  }
  const g = document.getElementById('tasks-grid');
  g.innerHTML = '';
  const noTasksElem = document.getElementById('no-tasks');
  if(noTasksElem) noTasksElem.remove();
  if(!tasks || tasks.length === 0){
    const nt = document.createElement('div');
    nt.id = 'no-tasks'; nt.className='center muted'; nt.textContent='No tasks to print';
    g.parentNode.appendChild(nt);
    return;
  }
  tasks.forEach(t=>{
    const card = document.createElement('div');
    card.className='task-card';
    card.setAttribute('data-id', t.id);

    const row = document.createElement('div'); row.className='task-row';
    const title = document.createElement('div'); title.className='task-title'; title.textContent = t.title;
    row.appendChild(title);
    if(t.priority){
      const pri = document.createElement('div'); pri.className = 'priority ' + (t.priority || '').toLowerCase(); pri.textContent = t.priority;
      row.appendChild(pri);
    }
    card.appendChild(row);

    const meta = document.createElement('div'); meta.className='task-meta small'; meta.textContent = (t.due_date || '—') + ' · ' + (t.project || '—');
    card.appendChild(meta);

    const actions = document.createElement('div'); actions.className='task-actions';
    const printBtn = document.createElement('button'); printBtn.className='btn btn-sm'; printBtn.type='button'; printBtn.textContent = 'Print';
    printBtn.addEventListener('click', async (e)=>{ e.preventDefault(); printTaskClient(t.id, printBtn, t.title); });
    actions.appendChild(printBtn);
    const a = document.createElement('a'); a.className='btn'; a.href = '/tasks/' + t.id; a.textContent='Details';
    actions.appendChild(a);
    card.appendChild(actions);

    g.appendChild(card);
  });
}

async function refreshTasks(){
  try{
    const res = await fetch('/api/v1/tasks');
    const body = await res.json();
    renderTasks(body.data || []);
  }catch(e){ console.error(e); }
}

// Polling auto-refresh (skip when tab is hidden), similar to task_details
const POLL_INTERVAL = 8000; // ms
let _pollTimer = null;
function startPolling(){
  if(_pollTimer) clearInterval(_pollTimer);
  _pollTimer = setInterval(()=>{
    if(!document.hidden){
      refreshTasks();
    }
  }, POLL_INTERVAL);
}

// refresh immediately when tab becomes visible
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshTasks(); });

// start on load
document.addEventListener('DOMContentLoaded', ()=>{ refreshTasks(); startPolling(); });

function showBusy(message = 'Working...'){
  const overlay = document.getElementById('busy-overlay');
  if(!overlay) return;
  overlay.classList.remove('hidden');
  overlay.setAttribute('aria-hidden', 'false');
  const txt = overlay.querySelector('.busy-text');
  if(txt) txt.textContent = message;
}
function hideBusy(){
  const overlay = document.getElementById('busy-overlay');
  if(!overlay) return;
  overlay.classList.add('hidden');
  overlay.setAttribute('aria-hidden', 'true');
}

document.getElementById("print-all").addEventListener("click", async () => {
  const btn = document.getElementById('print-all');
    try{
      btn.disabled = true;
      showBusy('Printing all tasks...');
      const response = await fetch("/api/v1/tasks/print", { method: "POST" });
      let result = {};
      try{ result = await response.json(); }catch(e){ /* not json */ }
      if(!response.ok){
        const msg = result.detail || result.message || `Print request failed (status ${response.status})`;
        showToast('error', msg);
        console.error('Print-all failed', result);
        return;
      }

      if(result.failures && result.failures.length){
        showToast('error', `${result.successes || 0} printed, ${result.failures.length} failed`);
        console.error('Print failures', result.failures);
      }else{
        showToast('success', result.message || 'Printed');
      }
      // fetch fresh tasks and re-render
      await refreshTasks();
    }catch(e){
      console.error('Print-all request error', e);
      showToast('error', 'Request failed: ' + (e && e.message ? e.message : String(e)));
    }
    finally{ btn.disabled = false; hideBusy(); }
});

document.getElementById("print-summary").addEventListener("click", async () => {
  const btn = document.getElementById('print-summary');
  try{
    btn.disabled = true;
    showBusy('Printing ToDo summary...');
    const res = await fetch('/api/v1/tasks/summary/print', { method: 'POST' });
    let body = {};
    try{ body = await res.json(); }catch(e){ /* not json */ }
    if(!res.ok){
      const msg = body.detail || body.message || `Summary print failed (status ${res.status})`;
      showToast('error', msg);
      console.error('Summary print failed', body);
      return;
    }
    showToast('success', body.message || 'ToDo summary printed');
  }catch(e){
    console.error('Summary print request error', e);
    showToast('error', 'Request failed: ' + (e && e.message ? e.message : String(e)));
  }finally{
    btn.disabled = false;
    hideBusy();
  }
});

document.getElementById("refresh-projects").addEventListener("click", async () => {
  const btn = document.getElementById('refresh-projects');
  try{
    btn.disabled = true;
    const res = await fetch('/api/v1/projects/refresh', { method: 'POST' });
    let body = {};
    try{ body = await res.json(); }catch(e){}
    if(!res.ok){ const msg = body.detail || body.message || `Refresh failed (status ${res.status})`; showToast('error', msg); console.error('Refresh failed', body); return; }
    showToast('success', `Projects refreshed`);
    // refresh visible tasks so project names update
    await refreshTasks();
  }catch(e){ console.error('Refresh request error', e); showToast('error', 'Request failed: ' + (e && e.message ? e.message : String(e))); }
  finally{ btn.disabled = false; }
});
</script>
</body>
</html>
